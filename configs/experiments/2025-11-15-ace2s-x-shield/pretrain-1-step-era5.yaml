# arg: --dataset oliverwm/era5-1deg-8layer-stats-1990-2019-v2:/statsdata
seed: 0
experiment_dir: /results
save_checkpoint: true
validate_using_ema: true
max_epochs: 120
ema:
  decay: 0.999
inference:
  epochs:
    start: 0
  n_forward_steps: 7300
  forward_steps_in_memory: 40
  loader:
    start_indices:
      times:
        - '1996-01-01T00:00:00'
        - '1996-02-15T00:00:00'
        - '1996-04-01T00:00:00'
        - '1996-05-15T00:00:00'
        - '1996-07-01T00:00:00'
        - '1996-08-15T00:00:00'
        - '1996-10-01T00:00:00'
        - '1996-11-15T00:00:00'
    dataset:
      data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
    num_data_workers: 8
  aggregator:
    log_histograms: true
    time_mean_reference_data: /statsdata/time-mean.nc
logging:
  log_to_screen: true
  log_to_wandb: true
  log_to_file: true
  project: ace
  entity: ai2cm
train_loader:
  batch_size: 8
  num_data_workers: 8
  prefetch_factor: 4
  dataset:
    strict: false
    concat:
      # Cut around the dates of ERA5 when parallel streams were merged
      # For details see Section 3 of H Hersbach, 2020 (https://rmets.onlinelibrary.wiley.com/doi/10.1002/qj.3803)
      # Also see https://github.com/ai2cm/explore2/blob/main/jeremym/era5/plot_skipped_years.py for further analysis
      # on the effect the the merging of parallel data streams in ERA5.
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        subset:
          start_time: '1979-01-01T00:00:00'
          stop_time: '1995-12-31'
      # note further bad dates according to the ERA5 papers are:
      # 1986 April 1
      # 1993 Aug 1
      # 2000 Jan 1
      # 2010 Jan 1
      # 2015 Jan 1
      # 2019 Mar 1 (though our data shows no jumps here, so we aren't skipping it)
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        subset:
          start_time: '2011-01-01'
          stop_time: '2014-12-31T18:00:00'
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        subset:
          start_time: '2015-01-01T00:00:00'
          stop_time: '2019-12-31'
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        subset:
          start_time: '2021-01-01'
  batch_size: 8
  num_data_workers: 4
  prefetch_factor: 4
validation_loader:
  batch_size: 32
  num_data_workers: 8
  prefetch_factor: 2
  dataset:
    data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
    subset:
      start_time: '1996-01-01'
      stop_time: '1997-12-31'
optimization:
  enable_automatic_mixed_precision: false
  lr: 0.0001
  optimizer_type: FusedAdam
  use_gradient_accumulation: true
  kwargs:
    weight_decay: 0.01
stepper:
  n_ensemble: 2
  train_n_forward_steps: 1
  optimize_last_step_only: true
  loss:
    type: EnsembleLoss
    weights:
      air_temperature_0: 0.5
      air_temperature_1: 0.5
      eastward_wind_0: 0.5
      northward_wind_0: 0.5
      specific_total_water_0: 0.5
      specific_total_water_1: 0.25
      specific_total_water_2: 0.5
      PRATEsfc: 0.5
      h500: 10
      TMP850: 5
      Q2m: 0.5
      DLWRFsfc: 2
      ULWRFsfc: 5
      USWRFsfc: 2
      DSWRFsfc: 2
      USWRFtoa: 2
      tendency_of_total_water_path_due_to_advection: 0.5
      PRESsfc: 3
    kwargs:
      crps_weight: 0.9
      energy_score_weight: 0.1
  step:
    type: single_module
    config:
      residual_prediction: false
      builder:
        type: NoiseConditionedSFNO
        config:
          embed_dim: 384
          noise_embed_dim: 64
          noise_type: isotropic
          filter_type: linear
          use_mlp: true
          num_layers: 8
          operator_type: dhconv
          separable: false
          spectral_layers: 3
          spectral_transform: sht
      normalization:
        network:
          global_means_path: /statsdata/centering.nc
          global_stds_path: /statsdata/scaling-full-field.nc
        residual:
          global_means_path: /statsdata/centering.nc
          global_stds_path: /statsdata/scaling-residual.nc
      ocean:
        surface_temperature_name: surface_temperature
        ocean_fraction_name: ocean_fraction
      corrector:
        conserve_dry_air: true
        moisture_budget_correction: advection_and_precipitation
        force_positive_names:
        - specific_total_water_0
        - specific_total_water_1
        - specific_total_water_2
        - specific_total_water_3
        - specific_total_water_4
        - specific_total_water_5
        - specific_total_water_6
        - specific_total_water_7
        - Q2m
        - PRATEsfc
        - ULWRFsfc
        - ULWRFtoa
        - DLWRFsfc
        - DSWRFsfc
        - USWRFsfc
        - USWRFtoa
      next_step_forcing_names:
      - DSWRFtoa
      in_names:
      - land_fraction
      - ocean_fraction
      - sea_ice_fraction
      - DSWRFtoa
      - HGTsfc
      - global_mean_co2
      - PRESsfc
      - surface_temperature
      - TMP2m
      - Q2m
      - UGRD10m
      - VGRD10m
      - air_temperature_0
      - air_temperature_1
      - air_temperature_2
      - air_temperature_3
      - air_temperature_4
      - air_temperature_5
      - air_temperature_6
      - air_temperature_7
      - specific_total_water_0
      - specific_total_water_1
      - specific_total_water_2
      - specific_total_water_3
      - specific_total_water_4
      - specific_total_water_5
      - specific_total_water_6
      - specific_total_water_7
      - eastward_wind_0
      - eastward_wind_1
      - eastward_wind_2
      - eastward_wind_3
      - eastward_wind_4
      - eastward_wind_5
      - eastward_wind_6
      - eastward_wind_7
      - northward_wind_0
      - northward_wind_1
      - northward_wind_2
      - northward_wind_3
      - northward_wind_4
      - northward_wind_5
      - northward_wind_6
      - northward_wind_7
      out_names:
      - PRESsfc
      - surface_temperature
      - TMP2m
      - Q2m
      - UGRD10m
      - VGRD10m
      - air_temperature_0
      - air_temperature_1
      - air_temperature_2
      - air_temperature_3
      - air_temperature_4
      - air_temperature_5
      - air_temperature_6
      - air_temperature_7
      - specific_total_water_0
      - specific_total_water_1
      - specific_total_water_2
      - specific_total_water_3
      - specific_total_water_4
      - specific_total_water_5
      - specific_total_water_6
      - specific_total_water_7
      - eastward_wind_0
      - eastward_wind_1
      - eastward_wind_2
      - eastward_wind_3
      - eastward_wind_4
      - eastward_wind_5
      - eastward_wind_6
      - eastward_wind_7
      - northward_wind_0
      - northward_wind_1
      - northward_wind_2
      - northward_wind_3
      - northward_wind_4
      - northward_wind_5
      - northward_wind_6
      - northward_wind_7
      - LHTFLsfc
      - SHTFLsfc
      - PRATEsfc
      - ULWRFsfc
      - ULWRFtoa
      - DLWRFsfc
      - DSWRFsfc
      - USWRFsfc
      - USWRFtoa
      - tendency_of_total_water_path_due_to_advection
      - TMP850
      - h500
