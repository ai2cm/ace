experiment_dir: /results
save_checkpoint: true
validate_using_ema: true
ema:
  decay: 0.999
max_epochs: 10
n_coupled_steps: 4
inference:
  n_coupled_steps: 1456
  coupled_steps_in_memory: 8
  loader:
    num_data_workers: 1
    dataset:
      ocean:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-08-22-cm4-piControl-200yr-coupled-ocean.zarr
            engine: zarr
            subset:
              start_time: '0151-01-03T12:00:00' # earlier times nan
          - data_path: /climate-default
            file_pattern: 2025-08-07-cm4-piControl-200yr-ocean.zarr
            engine: zarr
            subset:
              start_time: '0151-01-03T12:00:00' # earlier times nan
      atmosphere:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-08-22-cm4-piControl-200yr-coupled-interpolate_sst-atmosphere.zarr
            engine: zarr
            subset:
              # NOTE: this is required to align the atmosphere and ocean start times
              start_time: '0151-01-03T12:00:00' # earlier times nan
          - data_path: /climate-default
            file_pattern: 2025-03-21-CM4-piControl-atmosphere-land-1deg-8layer-200yr.zarr
            engine: zarr
            subset:
              # NOTE: this is required to align the atmosphere and ocean start times
              start_time: '0151-01-03T12:00:00' # earlier times nan
    start_indices:
      times:
        - '0151-01-03T12:00:00'
        - '0171-01-03T12:00:00'
        - '0191-01-03T12:00:00'
        - '0211-01-03T12:00:00'
        - '0231-01-03T12:00:00'
        - '0251-01-03T12:00:00'
        - '0271-01-03T12:00:00'
        - '0291-01-03T12:00:00'
  aggregator:
    log_zonal_mean_images: false
    log_histograms: false
logging:
  log_to_screen: true
  log_to_wandb: true
  log_to_file: true
  project: ace-samudra-coupled-cm4
  entity: ai2cm
train_loader:
  batch_size: 16
  num_data_workers: 4
  prefetch_factor: 1
  dataset:
    - ocean:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-08-22-cm4-piControl-200yr-coupled-ocean.zarr
            engine: zarr
            subset:
              start_time: '0151-01-03T12:00:00' # earlier times nan
              stop_time: '0306-01-03T12:00:00'
          - data_path: /climate-default
            file_pattern: 2025-08-07-cm4-piControl-200yr-ocean.zarr
            engine: zarr
            subset:
              start_time: '0151-01-03T12:00:00' # earlier times nan
              stop_time: '0306-01-03T12:00:00'
      atmosphere:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-08-22-cm4-piControl-200yr-coupled-interpolate_sst-atmosphere.zarr
            engine: zarr
            subset:
              start_time: '0151-01-03T12:00:00' # earlier times nan
              stop_time: '0306-01-03T12:00:00'
          - data_path: /climate-default
            file_pattern: 2025-03-21-CM4-piControl-atmosphere-land-1deg-8layer-200yr.zarr
            engine: zarr
            subset:
              start_time: '0151-01-03T12:00:00' # earlier times nan
              stop_time: '0306-01-03T12:00:00'
validation_loader:
  batch_size: 16
  num_data_workers: 4
  prefetch_factor: 1
  dataset:
    - ocean:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-08-22-cm4-piControl-200yr-coupled-ocean.zarr
            engine: zarr
            subset:
              start_time: '0306-01-03T12:00:00'
              stop_time: '0311-01-03T12:00:00'
          - data_path: /climate-default
            file_pattern: 2025-08-07-cm4-piControl-200yr-ocean.zarr
            engine: zarr
            subset:
              start_time: '0306-01-03T12:00:00'
              stop_time: '0311-01-03T12:00:00'
      atmosphere:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-08-22-cm4-piControl-200yr-coupled-interpolate_sst-atmosphere.zarr
            engine: zarr
            subset:
              start_time: '0306-01-03T12:00:00'
              stop_time: '0311-01-03T12:00:00'
          - data_path: /climate-default
            file_pattern: 2025-03-21-CM4-piControl-atmosphere-land-1deg-8layer-200yr.zarr
            engine: zarr
            subset:
              start_time: '0306-01-03T12:00:00'
              stop_time: '0311-01-03T12:00:00'
optimization:
  use_gradient_accumulation: true
  enable_automatic_mixed_precision: false
  lr: 0.00001
  optimizer_type: AdamW
  kwargs:
    fused: true
    weight_decay: 0.01
  scheduler:
    schedulers:
      - type: LinearLR
        kwargs:
          start_factor: 0.01
          end_factor: 1.0
          total_iters: 900
        steps_per_iteration: true
      - type: ConstantLR
        kwargs:
          factor: 1.0
          total_iters: 7070
        steps_per_iteration: true
      - type: LinearLR
        kwargs:
          start_factor: 1.0
          end_factor: 0.0
          total_iters: 1928
        steps_per_iteration: true
    milestones: [900, 7970]
stepper:
  parameter_init:
    checkpoint_path: /ckpt.tar
  ocean:
    timedelta: 5D
    stepper:
      parameter_init:
        weights_path: null # required
      loss:
        type: MSE
      input_masking:
        mask_value: 0
        fill_value: 0.0
        exclude_names_and_prefixes:
          - land_fraction
      step:
        type: single_module
        config:
          builder:
            type: Samudra
            config:
              ch_width:
                - 200
                - 250
                - 300
                - 400
              dilation:
                - 1
                - 2
                - 4
                - 8
              n_layers:
                - 1
                - 1
                - 1
                - 1
              norm: instance
          normalization:
            network:
              global_means_path: /ocean_stats/centering.nc
              global_stds_path: /ocean_stats/scaling-full-field.nc
          corrector:
            type: ocean_corrector
            config:
              force_positive_names:
                - so_0
                - so_1
                - so_2
                - so_3
                - so_4
                - so_5
                - so_6
                - so_7
                - so_8
                - so_9
                - so_10
                - so_11
                - so_12
                - so_13
                - so_14
                - so_15
                - so_16
                - so_17
                - so_18
                - HI
              sea_ice_fraction_correction:
                sea_ice_fraction_name: ocean_sea_ice_fraction
                land_fraction_name: land_fraction
                remove_negative_ocean_fraction: false
                sea_ice_thickness_name: HI
          next_step_forcing_names:
            - DLWRFsfc
            - DSWRFsfc
            - LHTFLsfc
            - SHTFLsfc
            - PRATEsfc
            - eastward_surface_wind_stress
            - northward_surface_wind_stress
          in_names:
            - DLWRFsfc
            - DSWRFsfc
            - LHTFLsfc
            - SHTFLsfc
            - PRATEsfc
            - eastward_surface_wind_stress
            - northward_surface_wind_stress
            - land_fraction
            - sea_surface_fraction
            - deptho
            - hfgeou
            - sst
            - zos
            - so_0
            - so_1
            - so_2
            - so_3
            - so_4
            - so_5
            - so_6
            - so_7
            - so_8
            - so_9
            - so_10
            - so_11
            - so_12
            - so_13
            - so_14
            - so_15
            - so_16
            - so_17
            - so_18
            - thetao_0
            - thetao_1
            - thetao_2
            - thetao_3
            - thetao_4
            - thetao_5
            - thetao_6
            - thetao_7
            - thetao_8
            - thetao_9
            - thetao_10
            - thetao_11
            - thetao_12
            - thetao_13
            - thetao_14
            - thetao_15
            - thetao_16
            - thetao_17
            - thetao_18
            - uo_0
            - uo_1
            - uo_2
            - uo_3
            - uo_4
            - uo_5
            - uo_6
            - uo_7
            - uo_8
            - uo_9
            - uo_10
            - uo_11
            - uo_12
            - uo_13
            - uo_14
            - uo_15
            - uo_16
            - uo_17
            - uo_18
            - vo_0
            - vo_1
            - vo_2
            - vo_3
            - vo_4
            - vo_5
            - vo_6
            - vo_7
            - vo_8
            - vo_9
            - vo_10
            - vo_11
            - vo_12
            - vo_13
            - vo_14
            - vo_15
            - vo_16
            - vo_17
            - vo_18
            - ocean_sea_ice_fraction
            - HI
          out_names:
            - sst
            - zos
            - so_0
            - so_1
            - so_2
            - so_3
            - so_4
            - so_5
            - so_6
            - so_7
            - so_8
            - so_9
            - so_10
            - so_11
            - so_12
            - so_13
            - so_14
            - so_15
            - so_16
            - so_17
            - so_18
            - thetao_0
            - thetao_1
            - thetao_2
            - thetao_3
            - thetao_4
            - thetao_5
            - thetao_6
            - thetao_7
            - thetao_8
            - thetao_9
            - thetao_10
            - thetao_11
            - thetao_12
            - thetao_13
            - thetao_14
            - thetao_15
            - thetao_16
            - thetao_17
            - thetao_18
            - uo_0
            - uo_1
            - uo_2
            - uo_3
            - uo_4
            - uo_5
            - uo_6
            - uo_7
            - uo_8
            - uo_9
            - uo_10
            - uo_11
            - uo_12
            - uo_13
            - uo_14
            - uo_15
            - uo_16
            - uo_17
            - uo_18
            - vo_0
            - vo_1
            - vo_2
            - vo_3
            - vo_4
            - vo_5
            - vo_6
            - vo_7
            - vo_8
            - vo_9
            - vo_10
            - vo_11
            - vo_12
            - vo_13
            - vo_14
            - vo_15
            - vo_16
            - vo_17
            - vo_18
            - ocean_sea_ice_fraction
            - HI
  atmosphere:
    timedelta: 6h
    loss_contributions:
      n_steps: 2
      weight: 1.0
    stepper:
      parameter_init:
        weights_path: null # required
      loss:
        type: MSE
        weights:
          air_temperature_0: 0.5
          air_temperature_1: 0.5
          eastward_wind_0: 0.5
          northward_wind_0: 0.5
          specific_total_water_0: 0.5
          specific_total_water_1: 0.25
          specific_total_water_2: 0.5
          PRATEsfc: 0.5
          h500: 10
          TMP850: 5
          Q2m: 0.5
          DLWRFsfc: 2
          ULWRFsfc: 5
          USWRFsfc: 2
          DSWRFsfc: 2
          USWRFtoa: 2
          tendency_of_total_water_path_due_to_advection: 0.5
      step:
        type: single_module
        config:
          builder:
            type: NoiseConditionedSFNO
            config:
              embed_dim: 384
              noise_embed_dim: 0
              filter_type: linear
              use_mlp: true
              num_layers: 8
              operator_type: dhconv
              separable: false
              spectral_layers: 3
              spectral_transform: sht
          normalization:
            network:
              global_means_path: /atmos_stats/centering.nc
              global_stds_path: /atmos_stats/scaling-full-field.nc
            residual:
              global_means_path: /atmos_stats/centering.nc
              global_stds_path: /atmos_stats/scaling-residual.nc
          ocean:
            surface_temperature_name: surface_temperature
            ocean_fraction_name: ocean_fraction
            interpolate: true
          corrector:
            conserve_dry_air: true
            moisture_budget_correction: advection_and_precipitation
            force_positive_names:
              - specific_total_water_0
              - specific_total_water_1
              - specific_total_water_2
              - specific_total_water_3
              - specific_total_water_4
              - specific_total_water_5
              - specific_total_water_6
              - specific_total_water_7
              - Q2m
              - PRATEsfc
              - ULWRFsfc
              - ULWRFtoa
              - DLWRFsfc
              - DSWRFsfc
              - USWRFsfc
              - USWRFtoa
          next_step_forcing_names:
            - DSWRFtoa
          in_names:
            - land_fraction
            - lake_fraction
            - ocean_fraction
            - sea_ice_fraction
            - DSWRFtoa
            - HGTsfc
            - PRESsfc
            - surface_temperature
            - air_temperature_0
            - air_temperature_1
            - air_temperature_2
            - air_temperature_3
            - air_temperature_4
            - air_temperature_5
            - air_temperature_6
            - air_temperature_7
            - specific_total_water_0
            - specific_total_water_1
            - specific_total_water_2
            - specific_total_water_3
            - specific_total_water_4
            - specific_total_water_5
            - specific_total_water_6
            - specific_total_water_7
            - eastward_wind_0
            - eastward_wind_1
            - eastward_wind_2
            - eastward_wind_3
            - eastward_wind_4
            - eastward_wind_5
            - eastward_wind_6
            - eastward_wind_7
            - northward_wind_0
            - northward_wind_1
            - northward_wind_2
            - northward_wind_3
            - northward_wind_4
            - northward_wind_5
            - northward_wind_6
            - northward_wind_7
          out_names:
            - PRESsfc
            - surface_temperature
            - air_temperature_0
            - air_temperature_1
            - air_temperature_2
            - air_temperature_3
            - air_temperature_4
            - air_temperature_5
            - air_temperature_6
            - air_temperature_7
            - specific_total_water_0
            - specific_total_water_1
            - specific_total_water_2
            - specific_total_water_3
            - specific_total_water_4
            - specific_total_water_5
            - specific_total_water_6
            - specific_total_water_7
            - eastward_wind_0
            - eastward_wind_1
            - eastward_wind_2
            - eastward_wind_3
            - eastward_wind_4
            - eastward_wind_5
            - eastward_wind_6
            - eastward_wind_7
            - northward_wind_0
            - northward_wind_1
            - northward_wind_2
            - northward_wind_3
            - northward_wind_4
            - northward_wind_5
            - northward_wind_6
            - northward_wind_7
            - LHTFLsfc
            - SHTFLsfc
            - PRATEsfc
            - ULWRFsfc
            - ULWRFtoa
            - DLWRFsfc
            - DSWRFsfc
            - USWRFsfc
            - USWRFtoa
            - tendency_of_total_water_path_due_to_advection
            - TMP850
            - h500
            - TMP2m
            - Q2m
            - eastward_surface_wind_stress
            - northward_surface_wind_stress
  ocean_fraction_prediction:
    land_fraction_name: land_fraction
    sea_ice_fraction_name_in_atmosphere: sea_ice_fraction
    sea_ice_fraction_name: ocean_sea_ice_fraction
  sst_name: sst
