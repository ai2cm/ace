experiment_dir: /results
save_checkpoint: true
validate_using_ema: true
evaluate_before_training: true
ema:
  decay: 0.999
max_epochs: 30
inference:
  n_forward_steps: 7300
  forward_steps_in_memory: 10
  loader:
    start_indices:
      times:
        - "2033-01-01T00:00:00"
        - "2033-06-06T12:00:00"
        - "2033-11-09T18:00:00"
        - "2034-04-15T06:00:00"
        - "2034-09-18T18:00:00"
        - "2035-02-22T06:00:00"
        - "2035-07-28T12:00:00"
        - "2036-01-01T00:00:00"
        - "2041-01-01T00:00:00"
        - "2041-06-06T12:00:00"
        - "2041-11-09T18:00:00"
        - "2042-04-15T06:00:00"
        - "2042-09-18T18:00:00"
        - "2043-02-22T06:00:00"
        - "2043-07-28T12:00:00"
        - "2044-01-01T00:00:00"
        - "2049-01-01T00:00:00"
        - "2049-06-06T12:00:00"
        - "2049-11-09T18:00:00"
        - "2050-04-15T06:00:00"
        - "2050-09-18T18:00:00"
        - "2051-02-22T06:00:00"
        - "2051-07-28T12:00:00"
        - "2052-01-01T00:00:00"
    dataset:
      data_path: /climate-default/2026-01-28-vertically-resolved-1deg-c96-shield-som-ensemble-fme-dataset
      file_pattern: concatenated-1xCO2-2xCO2-4xCO2-ic_0003.zarr
      engine: zarr
    num_data_workers: 1
  aggregator:
    log_histograms: true
logging:
  log_to_screen: true
  log_to_wandb: true
  log_to_file: true
  project: ace-shield
  entity: ai2cm
train_loader:
  batch_size: 8
  num_data_workers: 4
  prefetch_factor: 4
  time_buffer: 1
  dataset:
    concat:
      - data_path: /climate-default/2026-01-28-vertically-resolved-c96-1deg-shield-amip-ensemble-dataset
        file_pattern: ic_0001.zarr
        engine: zarr
        subset:
          start_time: "1979-01-01"
          stop_time: "2008-12-31"
      - &amip_ic_0002_training_data
        data_path: /climate-default/2026-01-28-vertically-resolved-c96-1deg-shield-amip-ensemble-dataset
        file_pattern: ic_0002.zarr
        engine: zarr
        subset:  # Middle five years of 1979 - 1989 decade
          start_time: "1981-07-01"
          stop_time: "1986-06-30"
      - <<: *amip_ic_0002_training_data
        subset:  # Middle five years of 1989 - 1999 decade
          start_time: "1991-07-01"
          stop_time: "1996-06-30"
      - <<: *amip_ic_0002_training_data
        subset:  # Middle five years of 1999 - 2009 decade
          start_time: "2001-07-01"
          stop_time: "2006-06-30"
      - &equilibrium_climate_training_data
        data_path: /climate-default/2026-01-28-vertically-resolved-1deg-c96-shield-som-ensemble-fme-dataset
        file_pattern: 1xCO2-ic_0001.zarr
        engine: zarr
      - <<: *equilibrium_climate_training_data
        file_pattern: 2xCO2-ic_0001.zarr
      - <<: *equilibrium_climate_training_data
        file_pattern: 4xCO2-ic_0001.zarr
      - <<: *equilibrium_climate_training_data
        file_pattern: 1xCO2-ic_0002.zarr
        subset:
          start_time: "2032-01-01"
          stop_time: "2036-12-31"
      - <<: *equilibrium_climate_training_data
        file_pattern: 2xCO2-ic_0002.zarr
        subset:
          start_time: "2032-01-01"
          stop_time: "2036-12-31"
      - <<: *equilibrium_climate_training_data
        file_pattern: 4xCO2-ic_0002.zarr
        subset:
          start_time: "2032-01-01"
          stop_time: "2036-12-31"
validation_loader:
  batch_size: 32
  num_data_workers: 4
  prefetch_factor: 4
  dataset:
    concat:
      - data_path: /climate-default/2026-01-28-vertically-resolved-c96-1deg-shield-amip-ensemble-dataset
        file_pattern: ic_0001.zarr
        engine: zarr
        subset:
          start_time: "2009-01-01"
          stop_time: "2011-12-31"
      - &equilibrium_climate_validation_data
        data_path: /climate-default/2026-01-28-vertically-resolved-1deg-c96-shield-som-ensemble-fme-dataset
        file_pattern: 1xCO2-ic_0002.zarr
        engine: zarr
        subset:
          start_time: "2038-01-01"
          stop_time: "2038-12-31"
      - <<: *equilibrium_climate_validation_data
        file_pattern: 2xCO2-ic_0002.zarr
      - <<: *equilibrium_climate_validation_data
        file_pattern: 4xCO2-ic_0002.zarr
optimization:
  enable_automatic_mixed_precision: false
  lr: 0.0001
  optimizer_type: FusedAdam
  use_gradient_accumulation: true
  kwargs:
    weight_decay: 0.01
stepper:
  n_ensemble: 2
  train_n_forward_steps:
    outcomes:
      - steps: 1
        probability: 0.6
      - steps: 2
        probability: 0.2
      - steps: 4
        probability: 0.1
      - steps: 12
        probability: 0.05
      - steps: 20
        probability: 0.05
  optimize_last_step_only: true
  loss:
    type: EnsembleLoss
    weights:
      air_temperature_0: 0.5
      air_temperature_1: 0.5
      eastward_wind_0: 0.5
      northward_wind_0: 0.5
      specific_total_water_0: 0.5
      specific_total_water_1: 0.25
      specific_total_water_2: 0.5
      PRATEsfc: 0.5
      h500: 10
      TMP850: 5
      Q2m: 0.5
      DLWRFsfc: 2
      ULWRFsfc: 5
      USWRFsfc: 2
      DSWRFsfc: 2
      USWRFtoa: 2
      tendency_of_total_water_path_due_to_advection: 0.5
      PRESsfc: 3
    kwargs:
      crps_weight: 0.9
      energy_score_weight: 0.1
  step:
    type: single_module
    config:
      residual_prediction: false
      builder:
        type: NoiseConditionedSFNO
        config:
          embed_dim: 512
          noise_embed_dim: 64
          noise_type: isotropic
          filter_type: linear
          use_mlp: true
          num_layers: 8
          operator_type: dhconv
          separable: false
          spectral_layers: 3
          spectral_transform: sht
          affine_norms: true
      normalization:
        network:
          global_means_path: /statsdata/centering.nc
          global_stds_path: /statsdata/scaling-full-field.nc
        residual:
          global_means_path: /statsdata/centering.nc
          global_stds_path: /statsdata/scaling-residual.nc
      ocean:
        surface_temperature_name: surface_temperature
        ocean_fraction_name: ocean_fraction
        interpolate: true
      corrector:
        conserve_dry_air: true
        moisture_budget_correction: advection_and_precipitation
        force_positive_names:
          - specific_total_water_0
          - specific_total_water_1
          - specific_total_water_2
          - specific_total_water_3
          - specific_total_water_4
          - specific_total_water_5
          - specific_total_water_6
          - specific_total_water_7
          - Q2m
          - PRATEsfc
          - ULWRFsfc
          - ULWRFtoa
          - DLWRFsfc
          - DSWRFsfc
          - USWRFsfc
          - USWRFtoa
          - total_frozen_precipitation_rate
      next_step_forcing_names:
        - DSWRFtoa
        - global_mean_co2
      in_names:
        - land_fraction
        - ocean_fraction
        - sea_ice_fraction
        - DSWRFtoa
        - HGTsfc
        - PRESsfc
        - surface_temperature
        - TMP2m
        - Q2m
        - UGRD10m
        - VGRD10m
        - air_temperature_0
        - air_temperature_1
        - air_temperature_2
        - air_temperature_3
        - air_temperature_4
        - air_temperature_5
        - air_temperature_6
        - air_temperature_7
        - specific_total_water_0
        - specific_total_water_1
        - specific_total_water_2
        - specific_total_water_3
        - specific_total_water_4
        - specific_total_water_5
        - specific_total_water_6
        - specific_total_water_7
        - eastward_wind_0
        - eastward_wind_1
        - eastward_wind_2
        - eastward_wind_3
        - eastward_wind_4
        - eastward_wind_5
        - eastward_wind_6
        - eastward_wind_7
        - northward_wind_0
        - northward_wind_1
        - northward_wind_2
        - northward_wind_3
        - northward_wind_4
        - northward_wind_5
        - northward_wind_6
        - northward_wind_7
        - global_mean_co2
      out_names:
        - PRESsfc
        - surface_temperature
        - TMP2m
        - Q2m
        - UGRD10m
        - VGRD10m
        - air_temperature_0
        - air_temperature_1
        - air_temperature_2
        - air_temperature_3
        - air_temperature_4
        - air_temperature_5
        - air_temperature_6
        - air_temperature_7
        - specific_total_water_0
        - specific_total_water_1
        - specific_total_water_2
        - specific_total_water_3
        - specific_total_water_4
        - specific_total_water_5
        - specific_total_water_6
        - specific_total_water_7
        - eastward_wind_0
        - eastward_wind_1
        - eastward_wind_2
        - eastward_wind_3
        - eastward_wind_4
        - eastward_wind_5
        - eastward_wind_6
        - eastward_wind_7
        - northward_wind_0
        - northward_wind_1
        - northward_wind_2
        - northward_wind_3
        - northward_wind_4
        - northward_wind_5
        - northward_wind_6
        - northward_wind_7
        - LHTFLsfc
        - SHTFLsfc
        - PRATEsfc
        - ULWRFsfc
        - ULWRFtoa
        - DLWRFsfc
        - DSWRFsfc
        - USWRFsfc
        - USWRFtoa
        - tendency_of_total_water_path_due_to_advection
        - TMP850
        - h500
        - total_frozen_precipitation_rate
