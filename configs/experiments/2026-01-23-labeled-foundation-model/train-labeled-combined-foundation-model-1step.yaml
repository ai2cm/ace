# arg: --dataset oliverwm/era5-1deg-8layer-stats-1990-2019-v2:/statsdata
experiment_dir: /results
seed: 0
save_checkpoint: true
validate_using_ema: true
max_epochs: 20
ema:
  decay: 0.999
inference:
  n_forward_steps: 10220  # 7-year runs
  forward_steps_in_memory: 40
  n_ensemble_per_ic: 2
  loader:
    start_indices:
      times:
        - '2003-01-01T00:00:00'
        - '2004-06-01T00:00:00'
        - '2006-01-01T00:00:00'
        - '2007-06-01T00:00:00'
        - '2009-01-01T00:00:00'
        - '2010-06-01T00:00:00'
        - '2012-01-01T00:00:00'
        - '2013-06-01T00:00:00'
    dataset:
      data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
      labels: ["era5"]
    num_data_workers: 4
  aggregator:
    log_histograms: true
    time_mean_reference_data: /statsdata/time-mean.nc
    # monthly_reference_data: /refdata-era5/monthly_mean_data.nc
logging:
  log_to_screen: true
  log_to_wandb: true
  log_to_file: true
  project: ace
  entity: ai2cm
train_loader:
  batch_size: 8
  num_data_workers: 4
  prefetch_factor: 2
  dataset:
    strict: false
    concat:
      # ERA5 data splits
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        labels: ["era5"]
        subset:
          start_time: '1979-01-01T00:00:00'
          stop_time: '1986-03-31T18:00:00'
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        labels: ["era5"]
        subset:
          start_time: '1986-04-01T00:00:00'
          stop_time: '1993-07-31T18:00:00'
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        labels: ["era5"]
        subset:
          start_time: '1993-08-01T00:00:00'
          stop_time: '1998-12-31T18:00:00'

      # AMIP C96 SHiELD runs
      - data_path: /climate-default/2026-01-28-vertically-resolved-c96-1deg-shield-amip-ensemble-dataset/
        file_pattern: ic_0001.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: '1979-01-01'
          stop_time: '2020-12-31'
      - data_path: /climate-default/2026-01-28-vertically-resolved-c96-1deg-shield-amip-ensemble-dataset/
        file_pattern: ic_0002.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: '1979-01-01'
          stop_time: '2020-12-31'
      # C96 ramped clim SST and random CO2 runs
      - data_path: /climate-default/2025-08-22-vertically-resolved-1deg-c96-shield-ramped-climSST-random-CO2-ensemble-fme-dataset
        file_pattern: ramped-sst-1xCO2-random-perturbation.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: "2020-01-01T06:00:00"
      - data_path: /climate-default/2025-08-22-vertically-resolved-1deg-c96-shield-ramped-climSST-random-CO2-ensemble-fme-dataset
        file_pattern: ramped-sst-1xCO2-random-perturbation-ic_0002.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: "2020-01-01T06:00:00"
      - data_path: /climate-default/2025-08-22-vertically-resolved-1deg-c96-shield-ramped-climSST-random-CO2-ensemble-fme-dataset
        file_pattern: ramped-sst-2xCO2-random-perturbation.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: "2020-01-01T06:00:00"
      - data_path: /climate-default/2025-08-22-vertically-resolved-1deg-c96-shield-ramped-climSST-random-CO2-ensemble-fme-dataset
        file_pattern: ramped-sst-2xCO2-random-perturbation-ic_0002.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: "2020-01-01T06:00:00"
      - data_path: /climate-default/2025-08-22-vertically-resolved-1deg-c96-shield-ramped-climSST-random-CO2-ensemble-fme-dataset
        file_pattern: ramped-sst-4xCO2-random-perturbation.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: "2020-01-01T06:00:00"
      - data_path: /climate-default/2025-08-22-vertically-resolved-1deg-c96-shield-ramped-climSST-random-CO2-ensemble-fme-dataset
        file_pattern: ramped-sst-4xCO2-random-perturbation-ic_0002.zarr
        engine: zarr
        labels: ["c96-shield"]
        subset:
          start_time: "2020-01-01T06:00:00"

      # C96 SOM
      - data_path: /climate-default/2026-01-28-vertically-resolved-1deg-c96-shield-som-ensemble-fme-dataset
        file_pattern: 1xCO2-ic_0001.zarr
        engine: zarr
        labels: ["c96-shield"]
      - data_path: /climate-default/2026-01-28-vertically-resolved-1deg-c96-shield-som-ensemble-fme-dataset
        file_pattern: 2xCO2-ic_0001.zarr
        engine: zarr
        labels: ["c96-shield"]
      - data_path: /climate-default/2026-01-28-vertically-resolved-1deg-c96-shield-som-ensemble-fme-dataset
        file_pattern: 4xCO2-ic_0001.zarr
        engine: zarr
        labels: ["c96-shield"]

      # CM4 control and 1pctCO2 runs
      - data_path: /climate-default
        file_pattern: 2025-03-21-CM4-piControl-atmosphere-land-1deg-8layer-200yr.zarr
        engine: zarr
        labels: ["cm4"]
      - data_path: /climate-default
        file_pattern: 2025-06-18-CM4-1pctCO2-atmosphere-land-1deg-8layer-140yr.zarr
        engine: zarr
        labels: ["cm4"]

      # CM4 random CO2 runs
      - data_path: /climate-default/2025-12-02-CM4-like-AM4-random-CO2
        file_pattern: random-CO2-1xCO2-ic_0001.zarr
        engine: zarr
        labels: ["cm4"]
        subset:
          start_time: "0153-01-01T06:00:00"
      - data_path: /climate-default/2025-12-02-CM4-like-AM4-random-CO2
        file_pattern: random-CO2-2xCO2-ic_0001.zarr
        engine: zarr
        labels: ["cm4"]
        subset:
          start_time: "0153-01-01T06:00:00"
      - data_path: /climate-default/2025-12-02-CM4-like-AM4-random-CO2
        file_pattern: random-CO2-4xCO2-ic_0001.zarr
        engine: zarr
        labels: ["cm4"]
        subset:
          start_time: "0153-01-01T06:00:00"
      - data_path: /climate-default/2025-12-02-CM4-like-AM4-random-CO2
        file_pattern: random-CO2-1xCO2-ic_0002.zarr
        engine: zarr
        labels: ["cm4"]
        subset:
          start_time: "0153-01-01T06:00:00"
      - data_path: /climate-default/2025-12-02-CM4-like-AM4-random-CO2
        file_pattern: random-CO2-2xCO2-ic_0002.zarr
        engine: zarr
        labels: ["cm4"]
        subset:
          start_time: "0153-01-01T06:00:00"
      - data_path: /climate-default/2025-12-02-CM4-like-AM4-random-CO2
        file_pattern: random-CO2-4xCO2-ic_0002.zarr
        engine: zarr
        labels: ["cm4"]
        subset:
          start_time: "0153-01-01T06:00:00"

      # E3SMv3 AMIP run
      - data_path: /climate-default/2026-01-14-e3smv3-1deg-AMIP-1970-2020-ERA5-format
        labels: ["e3smv3"]
        subset:
           stop_time: '2020-12-31'

      # SCREAM
      - data_path: /climate-default/2025-11-20-scream-masked-Tmp204-update_co2_hgt_TmpNoNans
        labels: ["scream"]

      # X-SHiELD
      - data_path: /climate-default
        labels: ["x-shield"]
        file_pattern: 2025-09-16-X-SHiELD-AMIP-1deg-8layer-11yr.zarr
        engine: zarr
        subset:
           stop_time: '2023-12-31'

validation_loader:
  batch_size: 32
  num_data_workers: 4
  prefetch_factor: 2
  time_buffer: 4
  dataset:
    strict: false
    concat:
      - data_path: /climate-default/2024-06-20-era5-1deg-8layer-1940-2022-netcdfs
        labels: ["era5"]
        subset:
          start_time: '2010-01-01'
          stop_time: '2012-12-31'

optimization:
  enable_automatic_mixed_precision: false
  lr: 0.0001
  optimizer_type: FusedAdam
  kwargs:
    weight_decay: 0.01
stepper:
  n_ensemble: 2
  train_n_forward_steps: 1
  optimize_last_step_only: true
  loss:
    type: EnsembleLoss
    kwargs:
      crps_weight: 0.5
      energy_score_weight: 0.5
  step:
    type: single_module
    config:
      builder:
        type: NoiseConditionedSFNO
        conditional: true
        config:
          embed_dim: 512
          noise_embed_dim: 64
          noise_type: isotropic
          pos_embed: false
          context_pos_embed_dim: 32
          filter_type: linear
          use_mlp: true
          num_layers: 8
          operator_type: dhconv
          separable: false
          spectral_layers: 3
          spectral_transform: sht
          normalize_big_skip: true
          affine_norms: true
      normalization:
        network:
          global_means_path: /statsdata/centering.nc
          global_stds_path: /statsdata/scaling-full-field.nc
        residual:
          global_means_path: /statsdata/centering.nc
          global_stds_path: /statsdata/scaling-residual.nc
      ocean:
        surface_temperature_name: surface_temperature
        ocean_fraction_name: ocean_fraction
      corrector:
        # conserve_dry_air: true
        # moisture_budget_correction: advection_and_precipitation
        force_positive_names:
        - specific_total_water_0
        - specific_total_water_1
        - specific_total_water_2
        - specific_total_water_3
        - specific_total_water_4
        - specific_total_water_5
        - specific_total_water_6
        - specific_total_water_7
        - PRATEsfc
        - ULWRFsfc
        - ULWRFtoa
        - DLWRFsfc
        - DSWRFsfc
        - USWRFsfc
      next_step_forcing_names:
      - DSWRFtoa
      - global_mean_co2
      in_names:
      - x
      - y
      - z
      - land_fraction
      - ocean_fraction
      - sea_ice_fraction
      - DSWRFtoa
      - HGTsfc
      - global_mean_co2
      - PRESsfc
      - surface_temperature
      - air_temperature_0
      - air_temperature_1
      - air_temperature_2
      - air_temperature_3
      - air_temperature_4
      - air_temperature_5
      - air_temperature_6
      - air_temperature_7
      - specific_total_water_0
      - specific_total_water_1
      - specific_total_water_2
      - specific_total_water_3
      - specific_total_water_4
      - specific_total_water_5
      - specific_total_water_6
      - specific_total_water_7
      - eastward_wind_0
      - eastward_wind_1
      - eastward_wind_2
      - eastward_wind_3
      - eastward_wind_4
      - eastward_wind_5
      - eastward_wind_6
      - eastward_wind_7
      - northward_wind_0
      - northward_wind_1
      - northward_wind_2
      - northward_wind_3
      - northward_wind_4
      - northward_wind_5
      - northward_wind_6
      - northward_wind_7
      out_names:
      - PRESsfc
      - surface_temperature
      - air_temperature_0
      - air_temperature_1
      - air_temperature_2
      - air_temperature_3
      - air_temperature_4
      - air_temperature_5
      - air_temperature_6
      - air_temperature_7
      - specific_total_water_0
      - specific_total_water_1
      - specific_total_water_2
      - specific_total_water_3
      - specific_total_water_4
      - specific_total_water_5
      - specific_total_water_6
      - specific_total_water_7
      - eastward_wind_0
      - eastward_wind_1
      - eastward_wind_2
      - eastward_wind_3
      - eastward_wind_4
      - eastward_wind_5
      - eastward_wind_6
      - eastward_wind_7
      - northward_wind_0
      - northward_wind_1
      - northward_wind_2
      - northward_wind_3
      - northward_wind_4
      - northward_wind_5
      - northward_wind_6
      - northward_wind_7
      - LHTFLsfc
      - SHTFLsfc
      - PRATEsfc
      - ULWRFsfc
      - ULWRFtoa
      - DLWRFsfc
      - DSWRFsfc
      - USWRFsfc
      - tendency_of_total_water_path_due_to_advection
