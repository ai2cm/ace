experiment_dir: /results
save_checkpoint: true
save_best_inference_epoch_checkpoints: false
checkpoint_every_n_batches: 100
log_train_every_n_batches: 10
validate_using_ema: true
evaluate_before_training: true
ema:
  decay: 0.999
max_epochs: 20
n_coupled_steps: 4
inference:
  n_coupled_steps: 1440
  coupled_steps_in_memory: 8
  loader:
    num_data_workers: 1
    dataset:
      ocean:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-10-21-cm4-1pctCO2-140yr-no-smoothing-coupled-ocean.zarr
            engine: zarr
          - data_path: /climate-default
            file_pattern: 2025-10-16-cm4-1pctCO2-140yr-ocean-no-smoothing.zarr
            engine: zarr
      atmosphere:
        merge:
          - data_path: /climate-default
            file_pattern: 2025-10-21-cm4-1pctCO2-140yr-no-smoothing-coupled-interpolate_sst-atmosphere.zarr
            engine: zarr
          - data_path: /climate-default
            file_pattern: 2025-06-18-CM4-1pctCO2-atmosphere-land-1deg-8layer-140yr.zarr
            engine: zarr
    start_indices:
      times:
        # 8 evenly spaced, spanning training and validation sets
        - '0251-01-03T12:00:00'
        - '0262-06-22T12:00:00'
        - '0273-12-09T12:00:00'
        - '0285-05-28T12:00:00'
        - '0296-11-14T12:00:00'
        - '0308-05-03T12:00:00'
        - '0319-10-20T12:00:00'
        - '0331-04-08T12:00:00'
  aggregator:
    log_zonal_mean_images: false
    log_histograms: false
logging:
  log_to_screen: true
  log_to_wandb: true
  log_to_file: true
  project: ace-samudra-coupled-cm4
  entity: ai2cm
train_loader:
  batch_size: 16
  num_data_workers: 2
  prefetch_factor: 2
  strict_ensemble: false
  dataset:
    concat:
      - ocean:
          merge:
            - data_path: /climate-default
              file_pattern: 2025-10-21-cm4-1pctCO2-140yr-no-smoothing-coupled-ocean.zarr
              engine: zarr
              subset:
                start_time: '0256-01-03T12:00:00'
            - data_path: /climate-default
              file_pattern: 2025-10-16-cm4-1pctCO2-140yr-ocean-no-smoothing.zarr
              engine: zarr
              subset:
                start_time: '0256-01-03T12:00:00'
        atmosphere:
          merge:
            - data_path: /climate-default
              file_pattern: 2025-10-21-cm4-1pctCO2-140yr-no-smoothing-coupled-interpolate_sst-atmosphere.zarr
              engine: zarr
              subset:
                start_time: '0256-01-03T12:00:00'
            - data_path: /climate-default
              file_pattern: 2025-06-18-CM4-1pctCO2-atmosphere-land-1deg-8layer-140yr.zarr
              engine: zarr
              subset:
                start_time: '0256-01-03T12:00:00'
      - ocean:
          merge:
            - data_path: /climate-default
              file_pattern: 2025-10-20-cm4-piControl-200yr-no-smoothing-coupled-ocean.zarr
              engine: zarr
              subset:
                start_time: '0151-01-03T12:00:00' # earlier times nan
                stop_time: '0190-12-29T12:00:00'
            - data_path: /climate-default
              file_pattern: 2025-10-15-cm4-piControl-200yr-ocean-no-smoothing.zarr
              engine: zarr
              subset:
                start_time: '0151-01-03T12:00:00' # earlier times nan
                stop_time: '0190-12-29T12:00:00'
        atmosphere:
          merge:
            - data_path: /climate-default
              file_pattern: 2025-10-20-cm4-piControl-200yr-no-smoothing-coupled-interpolate_sst-atmosphere.zarr
              engine: zarr
              subset:
                start_time: '0151-01-03T12:00:00' # earlier times nan
                stop_time: '0190-12-29T12:00:00'
            - data_path: /climate-default
              file_pattern: 2025-03-21-CM4-piControl-atmosphere-land-1deg-8layer-200yr.zarr
              engine: zarr
              subset:
                start_time: '0151-01-03T12:00:00' # earlier times nan
              stop_time: '0190-12-29T12:00:00'
validation_loader:
  batch_size: 16
  num_data_workers: 2
  prefetch_factor: 2
  dataset:
    ocean:
      merge:
        - data_path: /climate-default
          file_pattern: 2025-10-21-cm4-1pctCO2-140yr-no-smoothing-coupled-ocean.zarr
          engine: zarr
          subset:
            start_time: '0251-01-03T12:00:00'
            stop_time: '0255-12-29T12:00:00'
        - data_path: /climate-default
          file_pattern: 2025-10-16-cm4-1pctCO2-140yr-ocean-no-smoothing.zarr
          engine: zarr
          subset:
            start_time: '0251-01-03T12:00:00'
            stop_time: '0255-12-29T12:00:00'
    atmosphere:
      merge:
        - data_path: /climate-default
          file_pattern: 2025-10-21-cm4-1pctCO2-140yr-no-smoothing-coupled-interpolate_sst-atmosphere.zarr
          engine: zarr
          subset:
            start_time: '0251-01-03T12:00:00'
            stop_time: '0255-12-29T12:00:00'
        - data_path: /climate-default
          file_pattern: 2025-06-18-CM4-1pctCO2-atmosphere-land-1deg-8layer-140yr.zarr
          engine: zarr
          subset:
            start_time: '0251-01-03T12:00:00'
            stop_time: '0255-12-29T12:00:00'
optimization:
  use_gradient_accumulation: true
  enable_automatic_mixed_precision: false
  lr: 0.0001
  optimizer_type: AdamW
  kwargs:
    fused: true
    weight_decay: 0.01
  scheduler:
    schedulers:
      - type: LinearLR
        step_each_iteration: true
        kwargs:
          start_factor: 0.01
          end_factor: 1
          total_iters: 2000
      - type: ConstantLR
        step_each_iteration: true
    milestones: [2000]
stepper_training:
  ocean:
    parameter_init:
      weights_path: /ocean_ckpt.tar
    loss:
      type: MSE
  atmosphere:
    parameter_init:
      weights_path: /atmos_ckpt.tar
      parameters:
        - frozen:
            include:
              - '*'
    loss_contributions:
      n_steps: 0
    loss:
      type: MSE
      weights:
        air_temperature_0: 0.5
        air_temperature_1: 0.5
        eastward_wind_0: 0.5
        northward_wind_0: 0.5
        specific_total_water_0: 0.5
        specific_total_water_1: 0.25
        specific_total_water_2: 0.5
        PRATEsfc: 0.5
        h500: 10
        TMP850: 5
        Q2m: 10
        TMP2m: 10
        UGRD10m: 2.5
        VGRD10m: 2.5
        DLWRFsfc: 2
        ULWRFsfc: 5
        USWRFsfc: 2
        DSWRFsfc: 2
        USWRFtoa: 2
        tendency_of_total_water_path_due_to_advection: 0.5
stepper:
  ocean_fraction_prediction:
    land_fraction_name: land_fraction
    sea_ice_fraction_name_in_atmosphere: sea_ice_fraction
  sst_name: sst
  ocean:
    timedelta: 5D
    # stepper added by job_runner/create_coupled_train_config.sh
  atmosphere:
    timedelta: 6h
    # stepper added by job_runner/create_coupled_train_config.sh
