experiment_dir: FME_OUTPUT_DIR
save_checkpoint: true
validate_using_ema: true
ema:
  decay: 0.999
max_epochs: 30
n_forward_steps: 2
inference:
  n_forward_steps: 7300
  forward_steps_in_memory: 40
  loader:
    start_indices:
      list:
        - 3650
        - 7300
        - 10950
        - 14600
        - 18250
        - 21900
        - 25550
        - 29200
        - 32850
        - 36500
        - 40150
        - 43800
        - 47450
        - 51100
        - 54750
        - 58400
    dataset:
      merge:
      - data_path: /pscratch/sd/e/elynnwu/fme-dataset/2025-04-01-e3smv3-1deg-AMIP-1970-2020
      - data_path: /pscratch/sd/e/elynnwu/fme-dataset
        file_pattern: 2026-02-03-e3smv3-1deg-AMIP-1970-2020-sfc-wind-stress-fixed.zarr
        engine: zarr
    num_data_workers: 2
  aggregator:
    log_histograms: true
logging:
  log_to_screen: true
  log_to_wandb: true
  log_to_file: true
  project: ace-eamv3
  entity: ai2cm
train_loader:
  batch_size: 16
  num_data_workers: 4
  time_buffer: 10
  prefetch_factor: 2
  dataset:
    merge:
    - data_path: /pscratch/sd/e/elynnwu/fme-dataset/2025-04-01-e3smv3-1deg-AMIP-1970-2020 
    - data_path: /pscratch/sd/e/elynnwu/fme-dataset
      file_pattern: 2026-02-03-e3smv3-1deg-AMIP-1970-2020-sfc-wind-stress-fixed.zarr
      engine: zarr
validation_loader:
  batch_size: 32
  num_data_workers: 4
  time_buffer: 10
  prefetch_factor: 2
  dataset:
    merge:
    - data_path: /pscratch/sd/e/elynnwu/fme-dataset/2025-04-01-e3smv3-1deg-AMIP-1970-2020
      subset:
        start_time: '1994-01-01'
        stop_time: '1995-12-31'    
    - data_path: /pscratch/sd/e/elynnwu/fme-dataset
      file_pattern: 2026-02-03-e3smv3-1deg-AMIP-1970-2020-sfc-wind-stress-fixed.zarr
      engine: zarr
      subset:
        start_time: '1994-01-01'
        stop_time: '1995-12-31'
optimization:
  enable_automatic_mixed_precision: false
  lr: 0.0001
  use_gradient_accumulation: true
  optimizer_type: AdamW
  kwargs:
    fused: true
    weight_decay: 0.01
stepper:
  loss:
    type: MSE
    weights:
      T_0: 0.5
      T_1: 0.5
      U_0: 0.5
      V_0: 0.5
      specific_total_water_0: 0.5
      specific_total_water_1: 0.25
      specific_total_water_2: 0.5
      surface_precipitation_rate: 2
      FLDS: 2
      surface_upward_longwave_flux: 5
      surface_upward_shortwave_flux: 2
      FSDS: 2
      top_of_atmos_upward_shortwave_flux: 2
      tendency_of_total_water_path_due_to_advection: 0.5
  step:
    type: single_module
    config:
      builder:
        type: NoiseConditionedSFNO
        config:
          embed_dim: 384
          noise_embed_dim: 0
          filter_type: linear
          use_mlp: true
          num_layers: 8
          operator_type: dhconv
          separable: false
          spectral_layers: 3
          spectral_transform: sht
      normalization:
        network:
          global_means_path: /pscratch/sd/e/elynnwu/fme-dataset/2026-02-03-e3smv3-1deg-AMIP-1970-2020-stats/centering.nc
          global_stds_path: /pscratch/sd/e/elynnwu/fme-dataset/2026-02-03-e3smv3-1deg-AMIP-1970-2020-stats/scaling-full-field.nc
          fill_nans_on_normalize: false
        residual:
          global_means_path: /pscratch/sd/e/elynnwu/fme-dataset/2026-02-03-e3smv3-1deg-AMIP-1970-2020-stats/centering.nc
          global_stds_path: /pscratch/sd/e/elynnwu/fme-dataset/2026-02-03-e3smv3-1deg-AMIP-1970-2020-stats/scaling-residual.nc
      ocean:
        surface_temperature_name: TS
        ocean_fraction_name: ocean_fraction
        interpolate: true
      corrector:
        conserve_dry_air: true
        moisture_budget_correction: advection_and_precipitation
        force_positive_names:
        - specific_total_water_0
        - specific_total_water_1
        - specific_total_water_2
        - specific_total_water_3
        - specific_total_water_4
        - specific_total_water_5
        - specific_total_water_6
        - specific_total_water_7
        - surface_precipitation_rate
        - surface_upward_longwave_flux
        - FLUT
        - FLDS
        - FSDS
        - surface_upward_shortwave_flux
        - top_of_atmos_upward_shortwave_flux
      next_step_forcing_names:
      - SOLIN
      in_names:
      - LANDFRAC
      - OCNFRAC
      - ICEFRAC
      - PHIS
      - SOLIN
      - PS
      - TS
      - T_0
      - T_1
      - T_2
      - T_3
      - T_4
      - T_5
      - T_6
      - T_7
      - specific_total_water_0
      - specific_total_water_1
      - specific_total_water_2
      - specific_total_water_3
      - specific_total_water_4
      - specific_total_water_5
      - specific_total_water_6
      - specific_total_water_7
      - U_0
      - U_1
      - U_2
      - U_3
      - U_4
      - U_5
      - U_6
      - U_7
      - V_0
      - V_1
      - V_2
      - V_3
      - V_4
      - V_5
      - V_6
      - V_7
      out_names:
      - PS
      - TS
      - T_0
      - T_1
      - T_2
      - T_3
      - T_4
      - T_5
      - T_6
      - T_7
      - specific_total_water_0
      - specific_total_water_1
      - specific_total_water_2
      - specific_total_water_3
      - specific_total_water_4
      - specific_total_water_5
      - specific_total_water_6
      - specific_total_water_7
      - U_0
      - U_1
      - U_2
      - U_3
      - U_4
      - U_5
      - U_6
      - U_7
      - V_0
      - V_1
      - V_2
      - V_3
      - V_4
      - V_5
      - V_6
      - V_7
      - LHFLX
      - SHFLX
      - surface_precipitation_rate
      - surface_upward_longwave_flux
      - FLUT
      - FLDS
      - FSDS
      - surface_upward_shortwave_flux
      - top_of_atmos_upward_shortwave_flux
      - tendency_of_total_water_path_due_to_advection
      - TAUX
      - TAUY
